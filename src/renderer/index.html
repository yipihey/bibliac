<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://sql.js.org; script-src 'self' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://sql.js.org 'unsafe-inline' 'wasm-unsafe-eval'; style-src 'self' https://cdn.jsdelivr.net 'unsafe-inline'; font-src 'self' https://cdn.jsdelivr.net; img-src 'self' data: blob:; connect-src 'self' file: https://sql.js.org https://api.adsabs.harvard.edu https://*.adsabs.harvard.edu https://arxiv.org https://*.arxiv.org; worker-src 'self' blob:">
  <title>ADS Reader</title>
  <link rel="stylesheet" href="styles.css">
  <!-- KaTeX for LaTeX rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
  <!-- Floating Back Button (appears over PDF in detail view) -->
  <button class="floating-back-btn" id="floating-back-btn" aria-label="Back to papers">‚Üê</button>

  <!-- Top Bar -->
  <div class="mobile-top-bar" id="mobile-top-bar">
    <button class="hamburger-btn" id="hamburger-btn" aria-label="Open menu">‚ò∞</button>
    <div class="mobile-toolbar-btns">
      <div class="mobile-sort-dropdown">
        <button class="mobile-tb-btn mobile-sort-btn" id="mobile-sort-btn" title="Sort papers">
          <span class="mobile-sort-label">Date</span>
          <span class="mobile-sort-dir">‚Üì</span>
        </button>
        <div class="mobile-sort-menu hidden" id="mobile-sort-menu">
          <div class="mobile-sort-option" data-sort="added">Date Added</div>
          <div class="mobile-sort-option" data-sort="year">Year</div>
          <div class="mobile-sort-option" data-sort="title">Title</div>
          <div class="mobile-sort-option" data-sort="author">Author</div>
          <div class="mobile-sort-option" data-sort="citations">Citations</div>
          <div class="mobile-sort-option" data-sort="rating">Rating</div>
        </div>
      </div>
      <button class="mobile-tb-btn" id="mobile-import-btn" title="Import files">+</button>
      <button class="search-btn" id="mobile-search-btn" aria-label="Search">üîç</button>
      <button class="mobile-tb-btn" id="mobile-select-btn" title="Select multiple">Select</button>
    </div>
    <img src="logo.svg" alt="ADS Reader" class="top-bar-logo" id="mobile-title">
  </div>

  <!-- iOS Selection Mode Bar -->
  <div class="mobile-selection-bar hidden" id="mobile-selection-bar">
    <button class="selection-cancel-btn" id="selection-cancel-btn">Cancel</button>
    <span class="selection-count" id="selection-count">Select Items</span>
    <button class="selection-action-btn-top" id="selection-actions-btn">Actions</button>
  </div>

  <!-- iOS Selection Action Sheet -->
  <div class="action-sheet-overlay hidden" id="action-sheet-overlay"></div>
  <div class="action-sheet hidden" id="selection-action-sheet">
    <div class="action-sheet-content">
      <button class="action-sheet-btn hidden" id="as-add-to-library-btn">Add to Library</button>
      <button class="action-sheet-btn" id="as-add-to-collection-btn">Add to Collection</button>
      <button class="action-sheet-btn hidden" id="as-remove-from-collection-btn">Remove from Collection</button>
      <button class="action-sheet-btn" id="as-sync-btn">Sync with ADS</button>
      <button class="action-sheet-btn" id="as-bibtex-btn">Copy BibTeX</button>
      <button class="action-sheet-btn" id="as-book-btn">Export as Book</button>
      <button class="action-sheet-btn action-sheet-danger" id="as-delete-btn">Delete</button>
    </div>
    <button class="action-sheet-cancel" id="as-cancel-btn">Cancel</button>
  </div>

  <!-- iOS Collections Picker Action Sheet -->
  <div class="action-sheet hidden" id="collections-action-sheet">
    <div class="action-sheet-content" id="collections-sheet-content">
      <!-- Populated dynamically -->
    </div>
    <button class="action-sheet-cancel" id="collections-cancel-btn">Cancel</button>
  </div>

  <!-- Mobile Drawer -->
  <div class="mobile-drawer-overlay" id="mobile-drawer-overlay"></div>
  <aside class="mobile-drawer" id="mobile-drawer">
    <div class="drawer-header">
      <span class="drawer-title">Menu</span>
      <button class="drawer-close" id="drawer-close-btn">‚úï</button>
    </div>
    <div class="drawer-content">
      <!-- Console (Activity Log) -->
      <div class="drawer-section">
        <div class="drawer-section-label drawer-toggle" id="drawer-console-toggle">
          Console
          <span class="drawer-section-arrow">‚ñ∂</span>
        </div>
        <div class="drawer-console hidden" id="drawer-console">
          <div class="drawer-console-log" id="drawer-console-log"></div>
        </div>
      </div>

      <!-- Keyboard Shortcuts -->
      <div class="drawer-section">
        <div class="drawer-section-label drawer-toggle" id="drawer-shortcuts-toggle">
          Shortcuts
          <span class="drawer-section-arrow">‚ñ∂</span>
        </div>
        <div class="drawer-shortcuts hidden" id="drawer-shortcuts">
          <div class="drawer-shortcuts-grid">
            <span class="shortcut-key">/</span><span>Search papers</span>
            <span class="shortcut-key">j/k</span><span>Next/Prev paper</span>
            <span class="shortcut-key">‚åòA</span><span>Select all</span>
            <span class="shortcut-key">‚å´</span><span>Remove paper</span>
            <span class="shortcut-key">s</span><span>Sync with ADS</span>
            <span class="shortcut-key">a</span><span>Open in ADS</span>
            <span class="shortcut-key">1/2/3</span><span>Unread/Reading/Read</span>
            <span class="shortcut-key">‚áß1/2/3</span><span>Rating 1/2/3</span>
            <span class="shortcut-key">0</span><span>Clear rating</span>
            <span class="shortcut-key">p</span><span>PDF tab</span>
            <span class="shortcut-key">‚áßP</span><span>Open in Preview</span>
            <span class="shortcut-key">+/-</span><span>Zoom PDF</span>
            <span class="shortcut-key">r</span><span>Rotate page</span>
            <span class="shortcut-key">f</span><span>Focus mode</span>
            <span class="shortcut-key">n</span><span>Notes panel</span>
            <span class="shortcut-key">‚åò‚áßN</span><span>Focus notes</span>
            <span class="shortcut-key">m</span><span>Toggle menu</span>
            <span class="shortcut-key">Esc</span><span>Exit/Cancel</span>
          </div>
        </div>
      </div>

      <!-- ADS Searches -->
      <div class="drawer-section">
        <div class="drawer-section-label">
          ADS Searches
          <button class="drawer-add-btn" id="drawer-add-search-btn" title="New Search">+</button>
        </div>
        <div class="drawer-nav-items" id="drawer-searches-list">
          <div class="drawer-placeholder">No saved searches</div>
        </div>
      </div>

      <!-- Settings -->
      <div class="drawer-section drawer-section-bottom">
        <div class="drawer-section-label">Settings</div>
        <div class="drawer-nav-items">
          <button class="drawer-nav-item" id="drawer-ads-token-btn">
            üîë ADS API Token
            <span class="nav-status" id="drawer-ads-status">‚óè</span>
          </button>
          <button class="drawer-nav-item" id="drawer-proxy-btn">
            üèõÔ∏è Library Proxy
            <span class="nav-status" id="drawer-proxy-status">‚óè</span>
          </button>
          <button class="drawer-nav-item" id="drawer-llm-btn">
            ü§ñ AI Integration
            <span class="nav-status" id="drawer-llm-status">‚óè</span>
          </button>
          <button class="drawer-nav-item" id="drawer-settings-btn">
            ‚öôÔ∏è PDF Preferences
          </button>
        </div>
      </div>
    </div>
  </aside>

  <!-- Loading Screen (shown while checking for existing library) -->
  <div id="loading-screen" class="screen">
    <div class="loading-container">
      <img src="logo.svg" alt="ADS Reader" class="loading-icon">
      <h1>ADS Reader</h1>
      <p class="loading-text">Loading library...</p>
      <div class="loading-spinner"></div>
    </div>
  </div>

  <!-- Setup Screen -->
  <div id="setup-screen" class="screen hidden">
    <div class="setup-container">
      <img src="logo.svg" alt="ADS Reader" class="setup-icon">
      <h1>Welcome to ADS Reader</h1>
      <p class="setup-subtitle">A scientific publication reader with NASA ADS integration</p>

      <div class="setup-section">
        <h2>Choose Your Library Location</h2>
        <p>Select a folder where your papers will be stored. For automatic sync across devices, choose a folder in iCloud Drive, Google Drive, or Dropbox.</p>

        <div class="setup-buttons">
          <button id="create-icloud-library-btn" class="primary-button icloud-btn">
            <span class="btn-icon">‚òÅÔ∏è</span> Create iCloud Library
          </button>
          <div class="setup-divider">
            <span>or</span>
          </div>
          <button id="select-folder-btn" class="secondary-button">
            Select Local Folder
          </button>
        </div>

        <p class="setup-hint">iCloud libraries sync automatically across all your Apple devices</p>
      </div>

      <div id="selected-path" class="selected-path hidden">
        <div class="path-label">Selected location:</div>
        <div class="path-value"></div>
        <div class="cloud-status"></div>
      </div>
    </div>
  </div>

  <!-- Main App Screen -->
  <div id="main-screen" class="screen hidden">
    <div class="titlebar-drag-region"></div>

    <!-- Collapsed Sidebar Toggle -->
    <div class="sidebar-collapsed-toggle hidden" id="sidebar-collapsed-toggle" title="Show Sidebar (‚åò‚å•S)">
      <span>üìö</span>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1>ADS Reader</h1>
        <div class="sidebar-header-actions">
          <button id="reload-btn" class="reload-btn" title="Reload App (Cmd+R)">‚Üª</button>
          <button id="sidebar-collapse-btn" class="collapse-btn" title="Hide Sidebar (‚åò‚å•S)">‚óÄ</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-header">Library</div>
        <div class="nav-item active" data-view="all">
          <span class="nav-icon">üìÑ</span>
          <span>All Papers</span>
          <span class="nav-count" id="paper-count">0</span>
        </div>
        <div class="nav-item" data-view="unread">
          <span class="nav-icon">üìñ</span>
          <span>Unread</span>
          <span class="nav-count" id="unread-count">0</span>
        </div>
        <div class="nav-item" data-view="reading">
          <span class="nav-icon">üìï</span>
          <span>Reading</span>
          <span class="nav-count" id="reading-count">0</span>
        </div>
        <div class="nav-item" data-view="read">
          <span class="nav-icon">‚úì</span>
          <span>Read</span>
          <span class="nav-count" id="read-count">0</span>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="section-header">
          Collections
          <button class="add-collection-btn" id="add-collection-btn" title="New Collection">+</button>
        </div>
        <div id="collections-list" class="collections-list">
          <div class="nav-item placeholder">No collections yet</div>
        </div>
      </div>

      <div class="sidebar-section settings-section">
        <div class="section-header collapsible" id="settings-header">
          <span>Settings</span>
          <span class="section-toggle" id="settings-toggle">‚ñº</span>
        </div>
        <div class="settings-items" id="settings-items">
          <!-- ADS API Token - Inline expandable -->
          <div class="settings-group" id="ads-settings-group">
            <div class="settings-group-header" id="ads-settings-btn">
              <span class="nav-icon">üîë</span>
              <span>ADS API Token</span>
              <span class="nav-status" id="ads-status">‚óè</span>
              <span class="settings-expand-icon">‚ñ∂</span>
            </div>
            <div class="settings-group-content hidden" id="ads-settings-content">
              <input type="password" id="ads-token-inline" placeholder="Enter ADS API token">
              <div class="settings-inline-actions">
                <a href="#" class="settings-help-link" id="ads-token-help-link">Get token</a>
                <button class="settings-save-btn" id="ads-token-save-inline">Save</button>
              </div>
            </div>
          </div>

          <!-- Library Proxy - Inline expandable -->
          <div class="settings-group" id="proxy-settings-group">
            <div class="settings-group-header" id="library-proxy-btn">
              <span class="nav-icon">üèõÔ∏è</span>
              <span>Library Proxy</span>
              <span class="nav-status" id="proxy-status">‚óè</span>
              <span class="settings-expand-icon">‚ñ∂</span>
            </div>
            <div class="settings-group-content hidden" id="proxy-settings-content">
              <input type="text" id="proxy-url-inline" placeholder="https://proxy.library.edu/login?url=">
              <div class="settings-inline-actions">
                <button class="settings-save-btn" id="proxy-save-inline">Save</button>
              </div>
            </div>
          </div>

          <!-- AI Integration - Opens modal (too complex for inline) -->
          <div class="nav-item" id="llm-settings-btn">
            <span class="nav-icon">ü§ñ</span>
            <span>AI Integration</span>
            <span class="nav-status" id="llm-status">‚óè</span>
          </div>

          <!-- Send Feedback -->
          <div class="nav-item feedback-btn" id="send-feedback-btn">
            <span class="nav-icon">üí¨</span>
            <span>Send Feedback</span>
          </div>
        </div>
      </div>

      <!-- Keyboard Shortcuts (collapsible) -->
      <div class="shortcuts-summary" id="shortcuts-summary">
        <div class="shortcuts-title" id="shortcuts-toggle">
          <span class="shortcuts-arrow">‚ñ∂</span>
          Shortcuts
        </div>
        <div class="shortcuts-grid hidden" id="shortcuts-grid">
          <span class="shortcut-key">/</span><span>Search</span>
          <span class="shortcut-key">j/k</span><span>Next/Prev</span>
          <span class="shortcut-key">s</span><span>Sync</span>
          <span class="shortcut-key">a</span><span>Open ADS</span>
          <span class="shortcut-key">p</span><span>PDF tab</span>
          <span class="shortcut-key">‚áßP</span><span>Open in Preview</span>
          <span class="shortcut-key">c</span><span>Collections</span>
          <span class="shortcut-key">n</span><span>Notes Panel</span>
          <span class="shortcut-key">‚åò‚áßN</span><span>Focus Mode</span>
          <span class="shortcut-key">1-3</span><span>Read status</span>
          <span class="shortcut-key">‚áß1-4</span><span>Rating</span>
          <span class="shortcut-key">+/-</span><span>Zoom</span>
          <span class="shortcut-key">r</span><span>Rotate</span>
          <span class="shortcut-key">‚å´</span><span>Delete</span>
          <span class="shortcut-key">‚åò‚å•I</span><span>Debug Console</span>
        </div>
      </div>

      <!-- Indexing progress indicator -->
      <div class="indexing-status hidden" id="indexing-status">
        <span class="indexing-icon">‚ö°</span>
        <span id="indexing-text">Indexing papers...</span>
      </div>

      <!-- Activity Console -->
      <div class="console-panel" id="console-panel">
        <div class="console-resize-handle" id="console-resize-handle"></div>
        <div class="console-header" id="console-header">
          <span class="console-title">Console</span>
          <span class="console-toggle" id="console-toggle">‚ñº</span>
        </div>
        <div class="console-content" id="console-content">
          <div class="console-log" id="console-log"></div>
        </div>
      </div>

      <!-- Library Picker -->
      <div class="library-picker" id="library-picker">
        <div class="current-library" id="current-library" title="Click to switch libraries">
          <span class="library-icon" id="library-icon">‚òÅÔ∏è</span>
          <div class="library-details">
            <span class="library-name" id="library-name">No Library</span>
            <span class="library-count" id="library-count">0 papers</span>
          </div>
          <span class="expand-icon">‚ñº</span>
        </div>
        <div class="library-dropdown hidden" id="library-dropdown">
          <div class="library-list" id="library-list">
            <!-- Libraries will be populated here -->
          </div>
          <div class="library-actions">
            <button class="new-library-btn" id="new-icloud-library">
              <span class="btn-icon">‚òÅÔ∏è</span> New iCloud Library
            </button>
            <button class="new-library-btn local desktop-only" id="new-local-library">
              <span class="btn-icon">üíª</span> New Local Library
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resize handle between sidebar and main content -->
    <div class="resize-handle" id="sidebar-resize" data-resize="sidebar"></div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Content Split -->
      <div class="content-split">
        <!-- Paper List Panel -->
        <div class="paper-list-panel" data-mobile-view="papers">
          <!-- Search section (hidden on mobile until search button tapped) -->
          <div class="search-section">
            <div class="search-wrapper">
              <input type="text" id="search-input" placeholder="Search... (/)">
              <button id="search-clear-btn" class="search-clear-btn" title="Clear search">&times;</button>
            </div>
            <div class="search-shortcuts">
            <button class="search-shortcut-btn" data-insert="author:">author:</button>
            <button class="search-shortcut-btn" data-insert="year:">year:</button>
            <button class="search-shortcut-btn" data-insert="title:">title:</button>
            <button class="search-shortcut-btn" data-insert="bibcode:">bibcode:</button>
            <button class="search-shortcut-btn" data-insert="journal:">journal:</button>
            <button class="search-shortcut-btn" data-insert="source:">source:</button>
            </div>
          </div>
          <!-- Toolbar buttons -->
          <div class="list-toolbar">
            <button id="import-btn" class="import-btn" title="Import files">+</button>
            <button id="ads-search-btn" class="ads-btn" title="Search ADS">ADS üîç</button>
            <div class="download-pdf-dropdown">
              <button id="download-pdf-btn" class="download-btn" title="Download PDFs for selected papers">‚¨á</button>
              <div class="download-pdf-menu hidden" id="download-pdf-menu">
                <!-- Populated dynamically based on ADS sources -->
              </div>
            </div>
          </div>
          <!-- Smart Search Toolbar (shown when viewing ADS search results) -->
          <div class="smart-search-toolbar hidden" id="smart-search-toolbar">
            <div class="search-toolbar-info">
              <span class="search-toolbar-name" id="search-toolbar-name">Search Name</span>
              <span class="search-toolbar-meta" id="search-toolbar-meta">0 results</span>
            </div>
            <div class="search-toolbar-actions">
              <button class="search-toolbar-btn" id="search-refresh-btn" title="Refresh results from ADS">‚Üª</button>
              <button class="search-toolbar-btn" id="search-edit-btn" title="Edit search">‚úé</button>
            </div>
          </div>
          <div class="paper-list" id="paper-list">
            <!-- Paper items rendered dynamically -->
          </div>
        </div>

        <!-- Resize handle between paper list and detail -->
        <div class="resize-handle" id="list-resize" data-resize="list"></div>

        <!-- Paper Detail / PDF Viewer -->
        <div class="paper-detail" id="paper-detail" data-mobile-view="detail">
          <div class="detail-placeholder" id="detail-placeholder">
            <p>Select a paper to view</p>
          </div>

          <!-- Main Content Area -->
          <div class="viewer-wrapper hidden" id="viewer-wrapper">
            <!-- Content row (tabs + annotations) -->
            <div class="viewer-content-row">
              <!-- Tab Content -->
              <div class="tab-content" id="tab-content">
              <!-- PDF Tab -->
              <div class="tab-pane active" id="tab-pdf">
                <div class="pdf-container" id="pdf-container" data-mobile-view="pdf">
                  <div class="pdf-loading" id="pdf-loading">Loading PDF...</div>
                </div>
              </div>

              <!-- Abstract Tab -->
              <div class="tab-pane hidden" id="tab-abstract">
                <div class="abstract-content" id="abstract-content">
                  <p class="no-content">No abstract available. Click "Sync" to retrieve metadata from ADS.</p>
                </div>
                <div class="keywords-section" id="keywords-section">
                  <h4>Keywords</h4>
                  <div id="keywords-list"></div>
                </div>
              </div>

              <!-- References Tab -->
              <div class="tab-pane hidden" id="tab-refs">
                <div class="refs-toolbar hidden" id="refs-toolbar">
                  <span id="refs-count">0 references</span>
                  <div class="refs-actions">
                    <button class="text-button" id="refs-load-all" title="Load all references from ADS">Load All</button>
                    <button class="text-button" id="refs-select-all">Select All</button>
                  </div>
                </div>
                <div class="refs-list" id="refs-list">
                  <p class="no-content">No references loaded. Click "Sync" to retrieve from ADS.</p>
                </div>
              </div>

              <!-- Citations Tab -->
              <div class="tab-pane hidden" id="tab-cites">
                <div class="cites-toolbar hidden" id="cites-toolbar">
                  <span id="cites-count">0 citations</span>
                  <div class="cites-limit-controls">
                    <input type="number" id="cites-limit-input" value="50" min="1" max="2000" title="Number of citations to fetch">
                    <button class="text-button" id="cites-load-more" title="Fetch citations">Load</button>
                    <button class="text-button" id="cites-load-all" title="Fetch all citations">All</button>
                  </div>
                  <div class="cites-actions">
                    <button class="text-button" id="cites-select-all">Select All</button>
                  </div>
                </div>
                <div class="cites-list" id="cites-list">
                  <p class="no-content">No citations loaded. Click "Sync" to retrieve from ADS.</p>
                </div>
              </div>

              <!-- Info Tab -->
              <div class="tab-pane hidden" id="tab-bibtex">
                <!-- Files Panel (unified view of all paper files) -->
                <div class="files-panel" id="files-panel">
                  <div class="files-header">
                    <h4>Files</h4>
                    <button class="icon-btn" id="files-attach-btn" title="Attach file">+</button>
                  </div>
                  <div class="files-list" id="files-list">
                    <!-- Populated by JS: existing files -->
                  </div>
                  <div class="files-available" id="files-available">
                    <!-- Populated by JS: available for download -->
                  </div>
                </div>

                <!-- Legacy File Information Section (hidden, keeping for backwards compatibility) -->
                <div class="bibtex-files-section hidden" id="bibtex-files-section">
                  <h4>Files</h4>
                  <div class="bibtex-files-list" id="bibtex-files-list">
                    <span class="no-files">No files attached</span>
                  </div>
                </div>

                <!-- Record Information Section -->
                <div class="bibtex-record-section" id="bibtex-record-section">
                  <h4>Record Information</h4>
                  <div class="bibtex-record-info" id="bibtex-record-info"></div>
                </div>

                <div class="bibtex-source-info hidden" id="bibtex-source-info"></div>
                <h4>BibTeX Entry</h4>
                <textarea class="bibtex-content" id="bibtex-content" readonly placeholder="No BibTeX available. Click 'Sync' to retrieve from ADS."></textarea>
                <div class="bibtex-buttons">
                  <button class="copy-btn" id="edit-bibtex-btn">Edit</button>
                  <button class="copy-btn hidden" id="save-bibtex-btn">Save</button>
                  <button class="copy-btn hidden" id="cancel-bibtex-btn">Cancel</button>
                  <button class="copy-btn" id="copy-bibtex-btn">Copy</button>
                  <button class="copy-btn" id="export-bibtex-btn">Export</button>
                </div>
              </div>

              <!-- AI Tab -->
              <div class="tab-pane hidden" id="tab-ai" data-mobile-view="ai">
                <div class="ai-panel">
                  <!-- Summary Section -->
                  <div class="ai-section resizable" id="ai-summary-section">
                    <div class="ai-section-header">
                      <h3>Summary</h3>
                      <div class="ai-section-actions">
                        <button class="icon-button" id="ai-copy-summary-btn" title="Copy summary to clipboard">&#x2398;</button>
                        <button class="text-button" id="ai-regenerate-btn" title="Regenerate summary">Regenerate</button>
                      </div>
                    </div>
                    <div class="ai-summary-content" id="ai-summary-content">
                      <div class="ai-placeholder">
                        <p>Click "Generate Summary" to create an AI-powered summary of this paper.</p>
                        <button class="primary-button" id="ai-generate-summary-btn">Generate Summary</button>
                      </div>
                    </div>
                    <div class="ai-key-points hidden" id="ai-key-points">
                      <h4>Key Points</h4>
                      <ul id="ai-key-points-list"></ul>
                    </div>
                  </div>

                  <!-- Resize handle between Summary and Q&A -->
                  <div class="ai-section-resize" data-resize-section="summary-qa"></div>

                  <!-- Q&A Section -->
                  <div class="ai-section resizable" id="ai-qa-section">
                    <div class="ai-section-header">
                      <h3>Ask AI</h3>
                      <div class="ai-section-actions">
                        <button class="icon-button" id="ai-copy-qa-btn" title="Copy last answer to clipboard">&#x2398;</button>
                        <button class="text-button" id="ai-clear-history-btn" title="Clear history">Clear</button>
                      </div>
                    </div>
                    <div class="ai-qa-history" id="ai-qa-history">
                      <div class="ai-qa-placeholder">
                        <p>Ask questions about this paper and get AI-powered answers.</p>
                        <div class="ai-suggested-questions">
                          <button class="suggested-question" data-question="Give a simplified explanation of the entire paper.">Simplified explanation</button>
                          <button class="suggested-question" data-question="What are the main findings and conclusions?">Main findings</button>
                          <button class="suggested-question" data-question="What methods were used in this research?">Methods used</button>
                          <button class="suggested-question" data-question="What are the limitations of this study?">Limitations</button>
                          <button class="suggested-question" data-question="How does this paper relate to other work in the field?">Related work</button>
                        </div>
                      </div>
                    </div>
                    <div class="ai-qa-input-wrapper">
                      <input type="text" id="ai-question-input" placeholder="Ask a question about this paper...">
                      <button class="primary-button" id="ai-ask-btn">Ask</button>
                    </div>
                  </div>

                  <!-- Resize handle between Q&A and Search -->
                  <div class="ai-section-resize" data-resize-section="qa-search"></div>

                  <!-- Semantic Search Section -->
                  <div class="ai-section resizable" id="ai-search-section">
                    <div class="ai-section-header">
                      <h3>
                        Semantic Search
                        <button class="info-icon-btn" id="semantic-search-info-btn" title="How semantic search works">i</button>
                      </h3>
                      <button class="text-button" id="ai-index-paper-btn" title="Index current paper for search">Index Paper</button>
                    </div>
                    <div class="ai-search-wrapper">
                      <input type="text" id="ai-search-input" placeholder="Search papers using natural language...">
                      <button class="primary-button" id="ai-search-btn">Search</button>
                    </div>
                    <div class="ai-search-results" id="ai-search-results">
                      <div class="ai-search-placeholder">
                        <p>Search across your indexed papers using natural language queries.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Connection Status -->
                  <div class="ai-status-bar" id="ai-status-bar">
                    <span class="ai-status-indicator" id="ai-status-indicator">&#x25CF;</span>
                    <span id="ai-status-text">Checking AI connection...</span>
                    <button class="text-button" id="ai-settings-link">Settings</button>
                  </div>
                </div>
              </div>

              <!-- Library Tab -->
              <div class="tab-pane hidden" id="tab-library">
                <div class="library-tab-content">
                  <!-- Libraries Section -->
                  <div class="library-section">
                    <div class="section-header">
                      <h3>Libraries</h3>
                      <div class="section-actions">
                        <button class="lib-action-btn" id="new-icloud-lib-btn" title="New iCloud Library">
                          + iCloud
                        </button>
                        <button class="lib-action-btn" id="new-local-lib-btn" title="New Local Library">
                          + Local
                        </button>
                      </div>
                    </div>
                    <div class="libraries-list" id="libraries-list">
                      <!-- Dynamically populated -->
                    </div>
                    <div class="library-io-actions">
                      <button class="lib-action-btn" id="export-lib-btn" title="Export library to .adslib file">
                        ‚Üì Export
                      </button>
                      <button class="lib-action-btn" id="import-lib-btn" title="Import library from .adslib file">
                        ‚Üë Import
                      </button>
                    </div>
                  </div>

                  <!-- Collections Section -->
                  <div class="library-section">
                    <div class="section-header">
                      <h3>Collections</h3>
                      <button class="lib-action-btn" id="new-collection-btn" title="New Collection">+</button>
                    </div>
                    <div class="collections-list" id="tab-collections-list">
                      <!-- Dynamically populated -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Semantic Search Info Popup -->
              <div class="info-popup hidden" id="semantic-search-info-popup">
                <div class="info-popup-content">
                  <button class="info-popup-close" id="semantic-search-info-close">&times;</button>
                  <h4>How Semantic Search Works</h4>
                  <p><strong>1. Index your papers:</strong> Click "Index Paper" to generate embeddings for each paper. This converts the paper text into vectors that capture meaning.</p>
                  <p><strong>2. Search by concept:</strong> Enter natural language queries like "papers about galaxy formation" or "machine learning in astronomy".</p>
                  <p><strong>3. Get relevant results:</strong> The search finds papers whose content is semantically similar to your query, even if the exact words don't match.</p>
                  <p class="info-note"><strong>Note:</strong> Semantic search requires Ollama with an embedding model (e.g., nomic-embed-text). Cloud providers do not support semantic search.</p>
                </div>
              </div>
            </div>

              <!-- Annotations resize handle -->
              <div class="resize-handle vertical hidden" id="annotations-resize" data-resize="annotations"></div>

              <!-- Collapsed Notes Toggle -->
              <div class="notes-collapsed-toggle hidden" id="notes-collapsed-toggle" title="Show Notes (‚åò‚å•N)">
                <span>üìù</span>
              </div>

              <!-- Annotations Panel -->
              <div class="annotations-panel hidden" id="annotations-panel" data-mobile-view="notes">
                <div class="annotations-header">
                  <button id="notes-collapse-btn" class="collapse-btn" title="Hide Notes (‚åò‚å•N)">‚ñ∂</button>
                  <h3>Notes <span class="annotations-count" id="annotations-count"></span></h3>
                  <div class="annotations-actions">
                    <button class="text-button desktop-only" id="focus-notes-btn" title="Focus Mode (‚åò‚áßN)">Focus</button>
                    <button class="text-button" id="export-annotations-btn" title="Export annotations to Markdown">Export</button>
                    <button class="text-button" id="add-note-btn" title="Add general note">+ Add</button>
                  </div>
                </div>
                <div class="annotations-list" id="annotations-list">
                  <div class="annotations-placeholder">
                    <p>Select text in the PDF and click "Add Note" to create an annotation.</p>
                    <p class="annotations-hint">Notes support <strong>Markdown</strong> and <strong>LaTeX</strong> equations (<code>$...$</code> or <code>$$...$$</code>).</p>
                  </div>
                </div>
              </div>
            </div><!-- end viewer-content-row -->

          </div>

          <!-- Hidden elements for storing full paper info -->
          <div id="paper-info-panel" class="hidden">
            <span id="paper-title"></span>
            <span id="paper-authors"></span>
            <span id="paper-year"></span>
            <span id="paper-journal"></span>
            <span id="paper-bibcode"></span>
            <span id="paper-doi"></span>
            <span id="paper-arxiv"></span>
          </div>
        </div>
      </div>

      <!-- Bottom Status Bar (outside content-split for mobile visibility) -->
      <div class="bottom-bar" id="bottom-bar">
        <div class="bottom-bar-left">
          <div class="info-tabs">
            <!-- Filter Select -->
            <select id="filter-select" class="status-select filter-select" title="Filter papers">
              <optgroup label="Status">
                <option value="all" selected>All</option>
                <option value="unread">Unread</option>
                <option value="reading">Reading</option>
                <option value="read">Read</option>
              </optgroup>
              <optgroup label="Collections" id="filter-collections-group">
                <!-- Dynamically populated -->
              </optgroup>
            </select>
            <button class="tab-btn mobile-only" data-tab="papers" title="Papers">‚â°</button>
            <button class="tab-btn active" data-tab="pdf" title="PDF">‚ñ§</button>
            <button class="tab-btn" data-tab="abstract" title="Abstract">Abs</button>
            <button class="tab-btn" data-tab="refs" title="References">‚Üí</button>
            <button class="tab-btn" data-tab="cites" title="Citations">‚Üê</button>
            <button class="tab-btn" data-tab="bibtex" title="Info">‚ìò</button>
            <button class="tab-btn" data-tab="ai" title="AI">AI</button>
            <button class="tab-btn" data-tab="library" title="Library">Lib</button>
            <button class="tab-btn sync-tab-btn" id="sync-tab-btn" title="Sync with ADS">‚ü≥</button>
            <button class="tab-btn mobile-only action-tab" id="download-tab-btn" title="Download/View PDF">‚¨á</button>
            <button class="tab-btn mobile-only action-tab" id="attach-tab-btn" title="Attach files">üìé</button>
            <button class="tab-btn mobile-only action-tab" id="cite-tab-btn" title="Copy cite">‚ùù</button>
            <button class="tab-btn mobile-only action-tab" id="ads-tab-btn" title="Open in ADS">‚Üó</button>
            <select id="mobile-rating-select" class="mobile-only mobile-rating-select" title="Rate paper">
              <option value="0">--</option>
              <option value="1">1 - Seminal</option>
              <option value="2">2 - Important</option>
              <option value="3">3 - Useful</option>
            </select>
          </div>
          <span class="separator desktop-only">|</span>
          <div class="pdf-controls desktop-only">
            <button class="pdf-btn" id="zoom-out-btn" title="Zoom out">‚àí</button>
            <span id="zoom-level">100%</span>
            <button class="pdf-btn" id="zoom-in-btn" title="Zoom in">+</button>
            <button class="pdf-btn" id="rotate-btn" title="Rotate page">‚Üª</button>
            <span class="page-info">
              <span id="current-page">1</span>/<span id="total-pages">1</span>
            </span>
          </div>
        </div>
        <div class="bottom-bar-center desktop-only">
          <span class="paper-title-bar" id="paper-title-bar" title="">Select a paper</span>
        </div>
        <div class="bottom-bar-right">
          <div class="mobile-download-dropdown">
            <button class="action-btn" id="mobile-download-btn" title="Download PDFs">‚¨á</button>
            <div class="mobile-download-menu hidden" id="mobile-download-menu">
              <!-- Populated dynamically based on ADS sources -->
            </div>
          </div>
          <select id="paper-rating-select" class="status-select rating-select" title="Rate paper (0-3 keys)">
            <option value="0">--</option>
            <option value="1">1 - Seminal</option>
            <option value="2">2 - Important</option>
            <option value="3">3 - Useful</option>
          </select>
          <button class="action-btn" id="attach-file-btn" title="Attach files">üìé</button>
          <button class="action-btn" id="copy-cite-btn" title="Copy cite command">‚ùù</button>
          <button class="action-btn" id="open-ads-btn" title="Open in ADS">‚Üó</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Focus Notes Mode Toolbar -->
  <div class="focus-notes-toolbar hidden" id="focus-notes-toolbar">
    <div class="focus-notes-info">
      <span class="focus-notes-icon">üìù</span>
      <span class="focus-notes-title" id="focus-notes-title">Taking notes...</span>
    </div>
    <div class="focus-notes-actions">
      <button class="focus-notes-exit-btn" id="focus-exit-btn">Save &amp; Exit</button>
    </div>
  </div>

  <!-- ADS Token Modal -->
  <div class="modal hidden" id="ads-token-modal">
    <div class="modal-content">
      <h2>NASA ADS API Token</h2>
      <p>Enter your ADS API token to enable metadata lookup, references, and citations.</p>
      <p class="modal-help">Get your token from <a href="#" id="ads-token-link">ui.adsabs.harvard.edu/user/settings/token</a></p>
      <input type="text" id="ads-token-input" placeholder="Enter your ADS API token">
      <div class="modal-actions">
        <button class="secondary-button" id="ads-cancel-btn">Cancel</button>
        <button class="primary-button" id="ads-save-btn">Save</button>
      </div>
      <div class="modal-status" id="ads-modal-status"></div>
    </div>
  </div>

  <!-- Library Proxy Modal -->
  <div class="modal hidden" id="library-proxy-modal">
    <div class="modal-content">
      <h2>Library Proxy</h2>
      <p>Enter your institution's proxy URL to access paywalled publisher PDFs.</p>
      <p class="modal-help">Example: https://proxy.library.edu/login?url=</p>
      <input type="text" id="library-proxy-input" placeholder="https://proxy.library.edu/login?url=">
      <div class="modal-actions">
        <button class="secondary-button" id="proxy-cancel-btn">Cancel</button>
        <button class="primary-button" id="proxy-save-btn">Save</button>
      </div>
      <div class="modal-status" id="proxy-modal-status"></div>
    </div>
  </div>

  <!-- Preferences Modal -->
  <div class="modal hidden" id="preferences-modal">
    <div class="modal-content">
      <h2>Preferences</h2>

      <h3>PDF Source Priority</h3>
      <p class="modal-help">Drag to reorder. Higher items are tried first when downloading PDFs.</p>
      <ul id="pdf-priority-list" class="priority-list">
        <li data-source="PUB_PDF" draggable="true">
          <span class="drag-handle">‚â°</span>
          <span class="source-name">Publisher PDF</span>
          <span class="source-desc">Peer-reviewed, highest quality</span>
        </li>
        <li data-source="ADS_PDF" draggable="true">
          <span class="drag-handle">‚â°</span>
          <span class="source-name">ADS Scan</span>
          <span class="source-desc">Scanned PDFs for older papers</span>
        </li>
        <li data-source="EPRINT_PDF" draggable="true">
          <span class="drag-handle">‚â°</span>
          <span class="source-name">arXiv</span>
          <span class="source-desc">Preprints, may differ from published</span>
        </li>
        <li data-source="AUTHOR_PDF" draggable="true">
          <span class="drag-handle">‚â°</span>
          <span class="source-name">Author PDF</span>
          <span class="source-desc">Author-hosted versions</span>
        </li>
      </ul>

      <div class="modal-actions">
        <button class="secondary-button" id="preferences-cancel-btn">Cancel</button>
        <button class="primary-button" id="preferences-save-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Collection Modal -->
  <div class="modal hidden" id="collection-modal">
    <div class="modal-content">
      <h2 id="collection-modal-title">New Collection</h2>
      <input type="text" id="collection-name-input" placeholder="Collection name">
      <div class="collection-type-toggle">
        <label>
          <input type="radio" name="collection-type" value="regular" checked>
          <span>Regular Collection</span>
        </label>
        <label>
          <input type="radio" name="collection-type" value="smart">
          <span>Smart Collection (saved search)</span>
        </label>
      </div>
      <div class="smart-collection-options hidden" id="smart-collection-options">
        <textarea id="collection-query-input" placeholder="Enter search query (e.g., status:unread year:2024)"></textarea>
        <p class="query-help">Filters: author:, year:, title:, journal:, status:(unread|reading|read), rating:(1-4), has:(pdf|notes), citations:>N</p>
      </div>
      <div class="modal-actions">
        <button class="secondary-button" id="collection-cancel-btn">Cancel</button>
        <button class="primary-button" id="collection-save-btn">Create</button>
      </div>
    </div>
  </div>

  <!-- ADS Search Modal -->
  <div class="modal hidden" id="ads-search-modal">
    <div class="modal-content ads-modal-content">
      <div class="ads-modal-header">
        <h2>Search ADS</h2>
        <button class="modal-close-btn" id="ads-close-btn">&times;</button>
      </div>

      <div class="ads-search-bar">
        <input type="text" id="ads-query-input" placeholder="e.g., author:smith year:2020-2024 galaxy">
        <button class="primary-button" id="ads-search-execute-btn">Search</button>
      </div>

      <div class="ads-shortcuts">
        <button class="ads-shortcut-btn" data-insert="author:">author:</button>
        <button class="ads-shortcut-btn" data-insert="year:">year:</button>
        <button class="ads-shortcut-btn" data-insert="title:">title:</button>
        <button class="ads-shortcut-btn" data-insert="abs:">abs:</button>
        <button class="ads-shortcut-btn" data-insert="bibcode:">bibcode:</button>
        <button class="ads-shortcut-btn" data-insert="arXiv:">arXiv:</button>
        <button class="ads-shortcut-btn" data-insert="doi:">doi:</button>
      </div>

      <div class="ads-results-header hidden" id="ads-results-header">
        <span id="ads-results-count">0 papers found</span>
        <div class="ads-select-buttons">
          <button class="text-button" id="ads-select-all-btn">Select All</button>
          <button class="text-button" id="ads-select-none-btn">None</button>
        </div>
      </div>

      <div class="ads-results-list" id="ads-results-list">
        <div class="ads-empty-state">
          <p>Enter a search query to find papers in NASA ADS</p>
        </div>
      </div>

      <div class="ads-progress hidden" id="ads-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="ads-progress-fill"></div>
        </div>
        <div class="progress-text" id="ads-progress-text">Importing...</div>
      </div>

      <div class="ads-modal-footer">
        <span class="ads-selected-count" id="ads-selected-count">0 selected</span>
        <button class="primary-button" id="ads-import-btn" disabled>Import Selected</button>
      </div>
    </div>
  </div>

  <!-- Smart Search Modal (Create/Edit) -->
  <div class="modal hidden" id="smart-search-modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 id="smart-search-modal-title">New ADS Search</h2>
        <button class="modal-close-btn" id="smart-search-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="smart-search-name">Name</label>
          <input type="text" id="smart-search-name" placeholder="e.g., Recent Cosmology Papers">
        </div>
        <div class="form-group">
          <label for="smart-search-query">ADS Query</label>
          <textarea id="smart-search-query" rows="3" placeholder="e.g., bibstem:arXiv AND arxiv_class:astro-ph.CO AND entdate:[NOW-7DAYS TO NOW]"></textarea>
          <div class="form-hint">Use ADS query syntax. See <a href="#" id="ads-query-help-link">ADS search help</a></div>
        </div>
        <div class="ads-shortcuts" style="margin-top: 8px;">
          <button class="ads-shortcut-btn" data-insert="author:" data-target="smart-search-query">author:</button>
          <button class="ads-shortcut-btn" data-insert="year:" data-target="smart-search-query">year:</button>
          <button class="ads-shortcut-btn" data-insert="bibstem:" data-target="smart-search-query">bibstem:</button>
          <button class="ads-shortcut-btn" data-insert="arxiv_class:" data-target="smart-search-query">arxiv_class:</button>
          <button class="ads-shortcut-btn" data-insert="entdate:[NOW-7DAYS TO NOW]" data-target="smart-search-query">Last 7 days</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="smart-search-cancel-btn">Cancel</button>
        <button class="primary-button" id="smart-search-save-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- ADS Sync Progress Modal -->
  <div class="modal hidden" id="ads-sync-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Syncing with ADS</h2>
        <button class="modal-close-btn" id="ads-sync-close-btn">&times;</button>
      </div>
      <div class="ads-sync-progress">
        <div class="sync-status" id="sync-status">Preparing...</div>
        <div class="sync-timer" id="sync-timer" style="text-align: center; font-size: 0.9em; color: #888; margin: 4px 0;">0:00</div>
        <div class="sync-progress-bar">
          <div class="sync-progress-fill" id="sync-progress-fill" style="width: 0%"></div>
        </div>
        <div class="sync-current-paper" id="sync-current-paper"></div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: center; gap: 10px;">
        <button class="secondary-button" id="sync-cancel-btn">Cancel</button>
        <button class="primary-button hidden" id="sync-close-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- ADS Lookup Modal -->
  <div class="modal hidden" id="ads-lookup-modal">
    <div class="modal-content ads-modal-content">
      <div class="ads-modal-header">
        <h2>Find Paper in ADS</h2>
        <button class="modal-close-btn" id="ads-lookup-close-btn">&times;</button>
      </div>

      <div class="ads-lookup-info">
        <p>Search ADS to find metadata for: <strong id="ads-lookup-paper-title">Paper Title</strong></p>
      </div>

      <div class="ads-search-bar">
        <input type="text" id="ads-lookup-query" placeholder="e.g., author:smith year:2020 title:galaxy">
        <button class="primary-button" id="ads-lookup-search-btn">Search</button>
      </div>

      <div class="ads-shortcuts">
        <button class="ads-shortcut-btn" data-insert="author:">author:</button>
        <button class="ads-shortcut-btn" data-insert="year:">year:</button>
        <button class="ads-shortcut-btn" data-insert="title:">title:</button>
        <button class="ads-shortcut-btn" data-insert="bibcode:">bibcode:</button>
        <button class="ads-shortcut-btn" data-insert="doi:">doi:</button>
      </div>

      <div class="ads-lookup-status hidden" id="ads-lookup-status">
        <span id="ads-lookup-status-text">Extracting metadata with AI...</span>
      </div>

      <div class="ads-results-list" id="ads-lookup-results">
        <div class="ads-empty-state">
          <p>Click Search to find matching papers in ADS</p>
        </div>
      </div>

      <div class="ads-modal-footer">
        <button class="text-button" id="ads-lookup-cancel-btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Paper Context Menu -->
  <div class="context-menu hidden" id="paper-context-menu">
    <div class="context-menu-item" id="ctx-open-ads">Open in ADS</div>
    <div class="context-menu-item" id="ctx-open-publisher">Open Publisher PDF</div>
    <div class="context-menu-item" id="ctx-sync-paper">Sync with ADS</div>
    <div class="context-menu-item" id="ctx-download-pdfs">Download PDFs</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item hidden" id="ctx-add-to-library">Add to Library</div>
    <div class="context-menu-item" id="ctx-add-to-collection">
      Add to Collection
      <span class="submenu-arrow">‚ñ∂</span>
    </div>
    <div class="context-submenu hidden" id="ctx-collections-submenu"></div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="ctx-remove-from-collection">Remove from Collection</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="ctx-export-book">Export as Book</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item ctx-danger" id="ctx-delete-papers">Delete</div>
  </div>

  <!-- LLM Settings Modal -->
  <div class="modal hidden" id="llm-modal">
    <div class="modal-content ai-settings-modal">
      <h2>AI Settings</h2>

      <!-- Active Provider Indicator -->
      <div class="active-provider-indicator" id="active-provider-indicator">
        <span class="indicator-label">Currently using:</span>
        <span class="indicator-value" id="active-provider-display">Loading...</span>
      </div>

      <!-- Provider Tabs -->
      <div class="provider-tabs" id="provider-tabs">
        <button class="provider-tab active" data-provider="ollama">
          <span class="provider-icon">üè†</span> Ollama
          <span class="provider-status" id="ollama-tab-status">‚óè</span>
        </button>
        <button class="provider-tab" data-provider="anthropic">
          <span class="provider-icon">ü§ñ</span> Claude
          <span class="provider-status" id="anthropic-tab-status">‚óè</span>
        </button>
        <button class="provider-tab" data-provider="gemini">
          <span class="provider-icon">‚ú®</span> Gemini
          <span class="provider-status" id="gemini-tab-status">‚óè</span>
        </button>
        <button class="provider-tab" data-provider="perplexity">
          <span class="provider-icon">üîç</span> Perplexity
          <span class="provider-status" id="perplexity-tab-status">‚óè</span>
        </button>
      </div>

      <!-- Provider Content Panels -->
      <div class="provider-panels">
        <!-- Ollama Panel -->
        <div class="provider-panel active" id="panel-ollama">
          <div class="form-group">
            <label for="llm-endpoint-input">Ollama Endpoint</label>
            <input type="text" id="llm-endpoint-input" placeholder="http://127.0.0.1:11434">
          </div>

          <div class="form-group">
            <label for="llm-model-select">Model</label>
            <select id="llm-model-select">
              <option value="">Loading models...</option>
            </select>
          </div>

          <div class="form-group">
            <label for="llm-embedding-select">Embedding Model (for semantic search)</label>
            <select id="llm-embedding-select">
              <option value="">Loading models...</option>
            </select>
          </div>

          <div class="llm-connection-status">
            <span class="llm-status-dot" id="ollama-status-dot">‚óè</span>
            <span id="ollama-status-text">Checking connection...</span>
            <button class="text-button" id="ollama-test-btn">Test</button>
          </div>
        </div>

        <!-- Anthropic (Claude) Panel -->
        <div class="provider-panel" id="panel-anthropic">
          <div class="form-group">
            <label for="anthropic-api-key">API Key</label>
            <div class="api-key-input-wrapper">
              <input type="password" id="anthropic-api-key" placeholder="sk-ant-...">
              <button class="text-button toggle-password" data-target="anthropic-api-key">Show</button>
            </div>
            <p class="form-help">Get your key from <a href="#" class="external-link" data-url="https://console.anthropic.com/settings/keys">console.anthropic.com</a></p>
          </div>

          <div class="form-group">
            <label for="anthropic-model-select">Model</label>
            <select id="anthropic-model-select">
              <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
              <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
              <option value="claude-3-opus-20240229">Claude 3 Opus</option>
            </select>
          </div>

          <div class="llm-connection-status">
            <span class="llm-status-dot" id="anthropic-status-dot">‚óè</span>
            <span id="anthropic-status-text">Not configured</span>
            <button class="text-button" id="anthropic-test-btn">Test</button>
          </div>
        </div>

        <!-- Google Gemini Panel -->
        <div class="provider-panel" id="panel-gemini">
          <div class="form-group">
            <label for="gemini-api-key">API Key</label>
            <div class="api-key-input-wrapper">
              <input type="password" id="gemini-api-key" placeholder="AIza...">
              <button class="text-button toggle-password" data-target="gemini-api-key">Show</button>
            </div>
            <p class="form-help">Get your key from <a href="#" class="external-link" data-url="https://makersuite.google.com/app/apikey">Google AI Studio</a></p>
          </div>

          <div class="form-group">
            <label for="gemini-model-select">Model</label>
            <select id="gemini-model-select">
              <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
              <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
              <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental)</option>
            </select>
          </div>

          <div class="llm-connection-status">
            <span class="llm-status-dot" id="gemini-status-dot">‚óè</span>
            <span id="gemini-status-text">Not configured</span>
            <button class="text-button" id="gemini-test-btn">Test</button>
          </div>
        </div>

        <!-- Perplexity Panel -->
        <div class="provider-panel" id="panel-perplexity">
          <div class="form-group">
            <label for="perplexity-api-key">API Key</label>
            <div class="api-key-input-wrapper">
              <input type="password" id="perplexity-api-key" placeholder="pplx-...">
              <button class="text-button toggle-password" data-target="perplexity-api-key">Show</button>
            </div>
            <p class="form-help">Get your key from <a href="#" class="external-link" data-url="https://www.perplexity.ai/settings/api">perplexity.ai/settings/api</a></p>
          </div>

          <div class="form-group">
            <label for="perplexity-model-select">Model</label>
            <select id="perplexity-model-select">
              <option value="llama-3.1-sonar-small-128k-online">Sonar Small (Online)</option>
              <option value="llama-3.1-sonar-large-128k-online">Sonar Large (Online)</option>
              <option value="llama-3.1-sonar-huge-128k-online">Sonar Huge (Online)</option>
            </select>
          </div>

          <div class="llm-connection-status">
            <span class="llm-status-dot" id="perplexity-status-dot">‚óè</span>
            <span id="perplexity-status-text">Not configured</span>
            <button class="text-button" id="perplexity-test-btn">Test</button>
          </div>
        </div>
      </div>

      <!-- Summary Prompt Section -->
      <div class="summary-prompt-section">
        <div class="form-group">
          <label for="summary-prompt-textarea">
            Summary System Prompt
            <button class="text-button" id="reset-summary-prompt-btn">Reset to default</button>
          </label>
          <textarea id="summary-prompt-textarea" rows="4" placeholder="Enter custom system prompt for summaries..."></textarea>
        </div>
      </div>

      <!-- Legacy status indicator for backward compatibility -->
      <div class="llm-connection-status hidden">
        <span class="llm-status-dot" id="llm-modal-status-dot">‚óè</span>
        <span id="llm-modal-status-text">Checking connection...</span>
        <button class="text-button hidden" id="llm-test-btn">Test Connection</button>
      </div>

      <div class="modal-actions">
        <button class="secondary-button" id="llm-cancel-btn">Cancel</button>
        <button class="primary-button" id="llm-save-btn">Save</button>
      </div>
    </div>
  </div>

  <!-- Library Conflict Modal -->
  <div class="modal hidden" id="conflict-modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2>Sync Conflict Detected</h2>
      <p>This library has changes from multiple devices that couldn't be merged automatically.</p>

      <div class="conflict-files">
        <div class="conflict-file main">
          <div class="conflict-file-icon">üíª</div>
          <div class="conflict-file-details">
            <div class="conflict-file-name">Current Version</div>
            <div class="conflict-file-meta" id="conflict-current-meta">This device's version</div>
          </div>
        </div>
        <div class="conflict-file other">
          <div class="conflict-file-icon">üì±</div>
          <div class="conflict-file-details">
            <div class="conflict-file-name" id="conflict-other-name">Other Device</div>
            <div class="conflict-file-meta" id="conflict-other-meta">Modified on another device</div>
          </div>
        </div>
      </div>

      <div class="conflict-actions">
        <button class="conflict-btn keep-current" id="conflict-keep-current">
          Keep This Device
        </button>
        <button class="conflict-btn keep-other" id="conflict-keep-other">
          Use Other Version
        </button>
        <button class="conflict-btn backup-both" id="conflict-backup-both">
          Backup Both
        </button>
      </div>

      <p class="conflict-note">Choosing "Backup Both" will save both versions and keep using the current one.</p>
    </div>
  </div>

  <!-- Delete Library Confirmation Modal -->
  <div class="modal hidden" id="delete-library-modal">
    <div class="modal-content" style="max-width: 550px;">
      <h2>Delete Library</h2>
      <p id="delete-library-message">Are you sure you want to delete this library?</p>

      <div class="delete-library-info">
        <div class="delete-library-name" id="delete-library-name">Library Name</div>
        <div class="delete-library-path" id="delete-library-path">/path/to/library</div>
        <div class="delete-library-size" id="delete-library-size">Total size: 0 MB</div>
      </div>

      <div class="delete-library-files" id="delete-library-files-section">
        <div class="delete-library-files-header">Files to be deleted:</div>
        <div class="delete-library-file-list" id="delete-library-file-list">
          <!-- File list populated by JS -->
        </div>
      </div>

      <div class="delete-library-actions">
        <button class="delete-library-btn danger" id="delete-library-delete-files">
          Delete Library & Files
        </button>
        <button class="delete-library-btn" id="delete-library-remove-only">
          Remove from List Only
        </button>
        <button class="delete-library-btn cancel" id="delete-library-cancel">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Library Migration Modal -->
  <div class="modal hidden" id="migration-modal">
    <div class="modal-content" style="max-width: 500px;">
      <h2>Welcome to the New ADS Reader</h2>
      <p id="migration-message">
        We found an existing library with <strong id="migration-paper-count">0</strong> papers.
        Would you like to enable iCloud sync so your library is accessible on all your devices?
      </p>

      <div class="migration-options">
        <div class="migration-option" id="migrate-icloud-option">
          <div class="migration-option-icon">‚òÅÔ∏è</div>
          <div class="migration-option-details">
            <div class="migration-option-title">Move to iCloud</div>
            <div class="migration-option-desc">Sync across Mac and iPhone/iPad</div>
          </div>
        </div>

        <div class="migration-option" id="migrate-local-option">
          <div class="migration-option-icon">üíª</div>
          <div class="migration-option-details">
            <div class="migration-option-title">Keep Local</div>
            <div class="migration-option-desc">Desktop-only, no sync</div>
          </div>
        </div>
      </div>

      <div id="migration-icloud-unavailable" class="migration-warning hidden">
        <p>iCloud is not available. Your library will be kept local.</p>
      </div>

      <div id="migration-progress" class="hidden">
        <p>Migrating library... Please wait.</p>
        <div class="progress-bar">
          <div class="progress-fill" id="migration-progress-fill"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div class="modal hidden" id="feedback-modal">
    <div class="modal-content feedback-modal-content">
      <div class="modal-header">
        <h2>Send Feedback</h2>
        <button class="modal-close-btn" id="feedback-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="feedback-type-selector">
          <label class="feedback-type">
            <input type="radio" name="feedback-type" value="bug" checked>
            <span class="type-icon">Bug Report</span>
          </label>
          <label class="feedback-type">
            <input type="radio" name="feedback-type" value="feature">
            <span class="type-icon">Feature Request</span>
          </label>
          <label class="feedback-type">
            <input type="radio" name="feedback-type" value="general">
            <span class="type-icon">General Feedback</span>
          </label>
        </div>

        <div class="feedback-form">
          <div class="form-group">
            <label for="feedback-subject">Subject</label>
            <input type="text" id="feedback-subject" placeholder="Brief description of your feedback">
          </div>

          <div class="form-group">
            <label for="feedback-description">Description</label>
            <textarea id="feedback-description" rows="6" placeholder="Please describe the issue or suggestion in detail..."></textarea>
          </div>

          <div class="feedback-options">
            <label class="checkbox-label">
              <input type="checkbox" id="include-system-info" checked>
              <span>Include system information (helps diagnose issues)</span>
            </label>
          </div>

          <div class="system-info-preview" id="system-info-preview">
            <!-- Populated dynamically when checkbox is checked -->
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="feedback-cancel-btn">Cancel</button>
        <button class="primary-button" id="feedback-submit-btn">Send Feedback</button>
      </div>
    </div>
  </div>

  <!-- Export Library Modal -->
  <div class="modal hidden" id="export-library-modal">
    <div class="modal-content export-modal-content">
      <div class="modal-header">
        <h2>Export Library</h2>
        <button class="modal-close-btn" id="export-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="export-name-section">
          <label for="export-library-name">Library name:</label>
          <input type="text" id="export-library-name" class="modal-input" placeholder="My Library">
        </div>

        <p class="export-summary" id="export-summary">
          Exporting <strong id="export-paper-count">0</strong> papers
        </p>

        <div class="export-options">
          <label class="export-option">
            <input type="checkbox" id="export-pdfs" checked>
            <span class="option-text">Include PDF files</span>
            <span class="option-size" id="export-pdfs-size"></span>
          </label>

          <label class="export-option">
            <input type="checkbox" id="export-refs" checked>
            <span class="option-text">Include references</span>
            <span class="option-size" id="export-refs-count"></span>
          </label>

          <label class="export-option">
            <input type="checkbox" id="export-cites" checked>
            <span class="option-text">Include citations</span>
            <span class="option-size" id="export-cites-count"></span>
          </label>

          <label class="export-option">
            <input type="checkbox" id="export-annotations" checked>
            <span class="option-text">Include annotations &amp; notes</span>
            <span class="option-size" id="export-annotations-count"></span>
          </label>
        </div>

        <div class="export-estimate">
          <span>Estimated size:</span>
          <strong id="export-total-size">calculating...</strong>
        </div>

        <div class="export-progress hidden" id="export-progress-section">
          <p id="export-progress-text">Preparing export...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="export-progress-fill"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="export-cancel-btn">Cancel</button>
        <button class="primary-button" id="export-share-btn">Share...</button>
        <button class="primary-button" id="export-save-btn">Export to File</button>
      </div>
    </div>
  </div>

  <!-- Export Book Modal -->
  <div class="modal hidden" id="export-book-modal">
    <div class="modal-content export-modal-content">
      <div class="modal-header">
        <h2>Export as Book</h2>
        <button class="modal-close-btn" id="export-book-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="export-name-section">
          <label for="export-book-title">Book title:</label>
          <input type="text" id="export-book-title" class="modal-input" placeholder="Selected Papers">
        </div>

        <p class="export-summary">
          Merging <strong id="export-book-count">0</strong> papers into a single PDF
        </p>

        <div class="export-book-info">
          <p class="export-book-note">
            Papers with PDFs will be merged in order. Papers without PDFs will have
            a summary page with abstract and BibTeX entry. A table of contents will
            be added at the beginning.
          </p>
          <div class="export-book-stats">
            <span id="export-book-with-pdf">0</span> with PDF,
            <span id="export-book-without-pdf">0</span> without PDF
          </div>
        </div>

        <div class="export-progress hidden" id="export-book-progress-section">
          <p id="export-book-progress-text">Preparing export...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="export-book-progress-fill"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="export-book-cancel-btn">Cancel</button>
        <button class="primary-button" id="export-book-share-btn">Share...</button>
        <button class="primary-button" id="export-book-save-btn">Export to File</button>
      </div>
    </div>
  </div>

  <!-- Import Library Modal -->
  <div class="modal hidden" id="import-library-modal">
    <div class="modal-content import-modal-content">
      <div class="modal-header">
        <h2>Import Library</h2>
        <button class="modal-close-btn" id="import-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="import-file-info" id="import-file-info">
          <span class="import-icon">üì¶</span>
          <div class="import-file-details">
            <div class="import-filename" id="import-filename">Select a .adslib file</div>
            <div class="import-meta" id="import-meta"></div>
          </div>
        </div>

        <div class="import-stats hidden" id="import-stats">
          <div class="import-stat">
            <span class="stat-value" id="import-paper-count">0</span>
            <span class="stat-label">papers</span>
          </div>
          <div class="import-stat">
            <span class="stat-value" id="import-pdf-count">0</span>
            <span class="stat-label">PDFs</span>
          </div>
          <div class="import-stat">
            <span class="stat-value" id="import-annotation-count">0</span>
            <span class="stat-label">notes</span>
          </div>
        </div>

        <div class="import-options hidden" id="import-options">
          <div class="import-name-section">
            <label for="import-library-name">Library name:</label>
            <input type="text" id="import-library-name" class="modal-input" placeholder="Imported Library">
          </div>

          <div class="import-mode">
            <label class="radio-option">
              <input type="radio" name="import-mode" value="new" checked>
              <span class="option-text">Create new library</span>
              <small class="option-hint">Creates a separate library you can switch to</small>
            </label>
            <label class="radio-option">
              <input type="radio" name="import-mode" value="merge">
              <span class="option-text">Add to current library</span>
              <small class="option-hint">Adds new papers, skips duplicates</small>
            </label>
          </div>

          <div class="import-checkboxes">
            <label class="export-option">
              <input type="checkbox" id="import-pdfs" checked>
              <span class="option-text">Import PDF files</span>
            </label>
            <label class="export-option">
              <input type="checkbox" id="import-annotations" checked>
              <span class="option-text">Import annotations &amp; notes</span>
            </label>
          </div>
        </div>

        <div class="import-progress hidden" id="import-progress-section">
          <p id="import-progress-text">Importing papers...</p>
          <div class="progress-bar">
            <div class="progress-fill" id="import-progress-fill"></div>
          </div>
        </div>

        <div class="import-result hidden" id="import-result-section">
          <p id="import-result-text">Import complete!</p>
          <div class="import-result-stats" id="import-result-stats"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary-button" id="import-cancel-btn">Cancel</button>
        <button class="primary-button" id="import-select-btn">Select File...</button>
        <button class="primary-button hidden" id="import-confirm-btn">Import</button>
      </div>
    </div>
  </div>

  <!-- Text Selection Context Menu (for AI Explain and Notes) -->
  <div class="context-menu hidden" id="text-context-menu">
    <div class="context-menu-item" id="ctx-add-note">Add Note</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="ctx-explain-text">Explain with AI</div>
    <div class="context-menu-item" id="ctx-copy-text">Copy</div>
  </div>

  <!-- AI Explanation Popup -->
  <div class="ai-explanation-popup hidden" id="ai-explanation-popup">
    <div class="ai-explanation-header">
      <span>AI Explanation</span>
      <button class="popup-close-btn" id="ai-explanation-close">&times;</button>
    </div>
    <div class="ai-explanation-content" id="ai-explanation-content">
      <div class="ai-loading">Generating explanation...</div>
    </div>
    <div class="ai-explanation-footer">
      <button class="text-button" id="ai-explanation-add-note">+ Add as Note</button>
    </div>
    <div class="ai-explanation-resize" id="ai-explanation-resize"></div>
  </div>

  <!-- Notification Toast -->
  <div class="notification-toast hidden" id="notification-toast"></div>

  <!-- Download Queue Panel (floating) -->
  <div class="download-queue-panel hidden" id="download-queue-panel">
    <div class="queue-header">
      <span class="queue-title">Downloads</span>
      <div class="queue-controls">
        <button class="icon-btn" id="queue-pause-btn" title="Pause all">||</button>
        <button class="icon-btn" id="queue-close-btn" title="Close">&times;</button>
      </div>
    </div>
    <div class="queue-list" id="queue-list">
      <!-- Active and pending downloads populated by JS -->
    </div>
    <div class="queue-console" id="queue-console">
      <!-- Console output for download progress -->
    </div>
    <div class="queue-summary" id="queue-summary">
      <!-- Summary: X active, Y pending -->
    </div>
  </div>

  <!-- Mobile PDF Controls -->
  <div class="mobile-pdf-controls" id="mobile-pdf-controls">
    <div class="pdf-controls-row">
      <button class="pdf-ctrl-btn" id="pdf-prev-page">&#9664;</button>
      <span class="pdf-page-indicator">
        <input type="number" id="pdf-page-input" min="1" value="1">
        <span>of <span id="pdf-total-pages">1</span></span>
      </span>
      <button class="pdf-ctrl-btn" id="pdf-next-page">&#9654;</button>
    </div>
    <div class="pdf-controls-row">
      <button class="pdf-ctrl-btn" id="pdf-zoom-out">&#8722;</button>
      <span class="pdf-zoom-level" id="pdf-zoom-display">100%</span>
      <button class="pdf-ctrl-btn" id="pdf-zoom-in">+</button>
      <button class="pdf-ctrl-btn" id="pdf-fit-width">&#8596;</button>
      <button class="pdf-ctrl-btn" id="pdf-fullscreen-btn" title="Fullscreen">&#x26F6;</button>
    </div>
  </div>

  <!-- PDF Fullscreen Close Button -->
  <button class="pdf-fullscreen-close hidden" id="pdf-fullscreen-close" title="Exit fullscreen">&times;</button>

  <!-- PDF Source Bottom Sheet (Mobile) -->
  <div class="pdf-source-sheet-overlay hidden" id="pdf-source-sheet-overlay"></div>
  <div class="pdf-source-sheet hidden" id="pdf-source-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Select PDF Source</div>
    <div class="sheet-options" id="sheet-options">
      <!-- Options populated by JS -->
    </div>
  </div>

  <!-- Mobile Library Picker Overlay -->
  <div class="mobile-library-overlay hidden" id="mobile-library-overlay">
    <div class="mobile-library-modal">
      <div class="mobile-library-header">
        <h2>Libraries</h2>
        <button class="mobile-library-close" id="mobile-library-close">&times;</button>
      </div>
      <div class="mobile-library-list" id="mobile-library-list">
        <!-- Libraries will be populated dynamically -->
      </div>
      <div class="mobile-library-actions">
        <button class="mobile-library-new-btn" id="mobile-library-new-btn">+ Create New Library</button>
      </div>
    </div>
  </div>

  <!-- Platform initialization (for iOS/Capacitor only) -->
  <script type="module" src="platform-init.js"></script>
  <!-- app.js is loaded differently for Electron (direct) vs iOS (bundled by vite) -->
  <script src="app.js"></script>
</body>
</html>
